/**
 * kifuParser.js v0.0.2
 *
 * Copyright (c) 2015 sandai <sandai310@gmail.com>
 * Released under the MIT license
 */

var kifuParser=function(e){function t(r){if(i[r])return i[r].exports;var n=i[r]={exports:{},id:r,loaded:!1};return e[r].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){"use strict";function r(e,t){var i="";if(null===e||"string"!=typeof e)throw new Error("KifuParser(source <-I need it yesterday!, format, json)");if(i=n(a.toLines(e),t),"noformat"===i)throw new Error("This is not a kifu.");return new f[i](e,i)}function n(e,t){for(var i="noformat",r=0,n=e.length,o="";n>r;r++){switch(o=a.trim(e[r]).charAt(0)){case"1":i=s.format("Kif");break;case"▲":case"△":case"▼":case"▽":i=s.format("Ki2");break;case"+":case"-":if(/\d/.test(a.trim(e[r]).charAt(1))){i=s.format("Csa");break}continue;default:continue}break}return i===s.format(t)?s.format(t):i}function o(e,t,i){var n=r(e,t),o=new c(n.parse());return o.build(),i!==!0?o.getKifuObject():o.getKifuJSON()}var a=i(1),s=i(2),c=i(3),u=i(4),p=i(5),h=i(6),f={Kif:u,Ki2:p,Csa:h};e.exports=o},function(e){"use strict";function t(e,t){function i(){}i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e}function i(e){for(var t=[],i=e.split(/\r?(?:\n|\r)/),r=0,n=i.length;n>r;r++)""!==i[r]&&t.push(i[r]);return t}function r(e){var t=new RegExp("^(?:[0-9]{4})\\/(?:(0?2)\\/([12][0-9]|0?[1-9])|(0?[469]|11)\\/(30|[12][0-9]|0?[1-9])|(0?[13578]|1[02])\\/(3[01]|[12][0-9]|0?[1-9]))(?:$|[\\s　]+(?:2[0-3]|[01][0-9]):(?:[0-5][0-9])(?:$|:(?:[0-5][0-9])$))");return t.test(e)}function n(e){var t;for(t in e)if("undefined"!=typeof t)return!1;return!0}var o=function(){return String.prototype.trim?function(e){return String.prototype.trim.call(e)}:function(e){return e.replace(/^[\s　]+|[\s　]+$/g,"")}}(),a=function(){function e(e){return i.lastIndex=0,i.test(e)?'"'+e.replace(i,function(e){var t=o[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function t(i,o){var s,c,u,p,h,f=r,l=o[i];switch(l&&"object"==typeof l&&"function"==typeof l.toJSON&&(l=l.toJSON(i)),"function"==typeof a&&(l=a.call(o,i,l)),typeof l){case"string":return e(l);case"number":return isFinite(l)?String(l):"null";case"boolean":case"null":return String(l);case"object":if(!l)return"null";if(r+=n,h=[],"[object Array]"===Object.prototype.toString.apply(l)){for(p=l.length,s=0;p>s;s+=1)h[s]=t(s,l)||"null";return u=0===h.length?"[]":r?"[\n"+r+h.join(",\n"+r)+"\n"+f+"]":"["+h.join(",")+"]",r=f,u}if(a&&"object"==typeof a)for(p=a.length,s=0;p>s;s+=1)c=a[s],"string"==typeof c&&(u=t(c,l),u&&h.push(e(c)+(r?": ":":")+u));else for(c in l)Object.prototype.hasOwnProperty.call(l,c)&&(u=t(c,l),u&&h.push(e(c)+(r?": ":":")+u));return u=0===h.length?"{}":r?"{\n"+r+h.join(",\n"+r)+"\n"+f+"}":"{"+h.join(",")+"}",r=f,u}}var i,r,n,o,a;return i=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,o={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},"function"==typeof JSON.stringify?JSON.stringify:function(e,i,o){var s;if(r="",n="","number"==typeof o)for(s=0;o>s;s+=1)n+=" ";else"string"==typeof o&&(n=o);if(a=i,i&&"function"!=typeof i&&("object"!=typeof i||"number"!=typeof i.length))throw new Error("JSON.stringify");return t("",{"":e})}}(),s={inherits:t,trim:o,toLines:i,validateDate:r,isEmptyObject:n,jsonStringify:a};e.exports=s},function(e,t,i){"use strict";var r=i(7),n=i(8),o=i(9),a=i(10),s=i(11),c=i(12),u=i(13),p=i(14),h=i(15),f=i(16),l=i(17),d=i(18),y=i(19),U={handicap:function(e){return"undefined"!=typeof c[e]?c[e]:c["その他"]},csaHandicap:function(e){return"undefined"!=typeof r[e]?r[e]:r["その他"]},initialPlacement:function(e){return"undefined"!=typeof p[e]?p[e]:null},specialMove:function(e){return"undefined"!=typeof d[e]?d[e]:null},csaSpecialMove:function(e){return"undefined"!=typeof a[e]?a[e]:null},format:function(e){return"undefined"!=typeof s[e]?s[e]:null},piece:function(e){return"undefined"!=typeof f[e]?f[e]:null},promotedPiece:function(e){return"undefined"!=typeof l[e]?l[e]:null},csaPiece:function(e){return"undefined"!=typeof o[e]?o[e]:null},zenkakNumber:function(e){return"undefined"!=typeof y[e]?y[e]:null},kansuji:function(e){return"undefined"!=typeof h[e]?h[e]:null},header:function(e){return"undefined"!=typeof u[e]?u[e]:null},csaHeader:function(e){return"undefined"!=typeof n[e]?n[e]:null},pieceToPieceMapKey:function(e){for(var t in f)if(f[t]===e)return t;return null},pieceToCsaPieceMapKey:function(e){for(var t in o)if(o[t]===e)return t;return null}};e.exports=U},function(e,t,i){"use strict";function r(e){this.kifu={},this.header=e.header||{},this.body=e.body}var n=i(1),o=i(2);r.createMainObject=function(){return[{}]},r.createVariationsObject=function(){return[]},r.createHeaderObject=function(){return{}},r.prototype.getKifuObject=function(){return this.kifu},r.prototype.getKifuJSON=function(){return n.jsonStringify(this.kifu)},r.prototype.build=function(){this.kifu.header=this.buildHeader(),this.kifu.source=this.buildBody()},r.prototype.buildHeader=function(){return"undefined"==typeof this.header.handicap&&this.addHandicapToHeader(o.handicap("平手")),"undefined"==typeof this.header.moves&&this.addMovesToHeader(),"undefined"==typeof this.header.turn&&this.addTurnToHeader(),this.header},r.prototype.addTurnToHeader=function(){this.header.turn=!0},r.prototype.addHandicapToHeader=function(e){this.header.handicap=e},r.prototype.addMovesToHeader=function(){var e=this.body.main.length-1;"undefined"!=typeof this.body.main[e].special&&(e-=1),this.header.moves=e},r.prototype.addVariation=function(e,t){"undefined"!=typeof e.variations?e.variations.push(t):e.variations=[t]},r.prototype.getVariationMove=function(e,t){for(var i=e[e.length-1],r=t-i[0];0>=r;)e.pop(),i=e[e.length-1],r=t-i[0];return i[1][r]},r.prototype.buildBody=function(){var e=[],t=this.body.main,i=this.body.variations||null,r={};if(e.push([0,t]),null!==i)for(var n=0,o=i.length;o>n;n++)r=this.getVariationMove(e,i[n][0]),this.addVariation(r,i[n][1]),e.push([i[n][0],i[n][1]]);return t},e.exports=r},function(e,t,i){"use strict";function r(e,t){this.source=e,this.format=t,this.stack=[]}var n=i(1),o=i(2),a=i(3);r.prototype.parseHeaderUsed=function(e){return e.match(/(\d+)▲(\d+)△(\d+)$/)},r.prototype.parseHeaderBoard=function(e){var t=[];if("+---------------------------+"!==e[0]&&"+---------------------------+"!==e[9])return null;for(var i=1,r=0,n=0;9>=i;i++){if(r=0,n=e[i].length,"|"!==e[i].charAt(r))return null;r+=1,n-=2;for(var a="",s="";n>r;r+=2){if(a=e[i].charAt(r),s=e[i].charAt(r+1),"v"===a){if(null===o.piece(s))return null;s=0-o.piece(s)}else{if(" "!==a)return null;if("・"===s)s=0;else{if(null===o.piece(s))return null;s=o.piece(s)}}t.push(s)}if("|"!==e[i].charAt(r))return null;if(r+=1,i!==o.kansuji(e[i].charAt(r)))return null}return t},r.prototype.parseHeaderHand=function(e){for(var t={},i=0,r="",n=0,a=e.split(/[\s　]/),s=0,c=a.length;c>s;s++){if(i=o.piece(a[s].charAt(0)),r=o.pieceToCsaPieceMapKey(i),n=""===a[s].charAt(1)?1:o.kansuji(a[s].charAt(1)),null===i||null===n)return null;t[r]=n}return t},r.prototype.parseHeader=function(e){for(var t=a.createHeaderObject(),i="",r="",s=null,c=this.nextLine(n.toLines(e)),u=c();u;u=c()){if("９ ８ ７ ６ ５ ４ ３ ２ １"===u)i=o.header(u.charAt(0));else{if(s=u.match(/^(.+?)：(.+)$/),null===s)continue;i=o.header(n.trim(s[1])),r=n.trim(s[2])}switch(i){case"start":case"end":if(!n.validateDate(r))continue;"undefined"==typeof t.date&&(t.date={}),t.date[i]=r;continue;case"title":case"event":case"opening":case"site":t[i]=r;continue;case"limit":"undefined"==typeof t.time&&(t.time={}),t.time[i]=r;continue;case"handicap":t.handicap||(t[i]=o.handicap(r));continue;case"tactics_black":case"tactics_white":"undefined"==typeof t.tactics&&(t.tactics={}),t.tactics[i.split("_")[1]]=r;continue;case"player_black":case"player_white":"undefined"==typeof t.players&&(t.players={}),t.players[i.split("_")[1]]=r;continue;case"used":var p=this.parseHeaderUsed(r);if(null===p)continue;"undefined"==typeof t.time&&(t.time={}),t.moves=parseInt(p[1],10),t.time[i]={black:parseInt(p[2],10),white:parseInt(p[3],10)};continue;case"board":for(var h=[],f=0;10>=f;f++){if(u=c(),null===u||"+"!==u.charAt(0)&&"|"!==u.charAt(0))throw new Error("position figure is invalid.");h.push(u)}if(h=this.parseHeaderBoard(h),null===h)throw new Error("position figure is invalid.");t.board=h,t.handicap=o.handicap("その他");continue;case"hand_black":case"hand_white":var l=this.parseHeaderHand(r);if(null===l)throw new Error("hand piece is invalid.");"undefined"==typeof t.hands&&(t.hands={}),t.hands[i.split("_")[1]]=l;continue;case"turn":t.turn=!1;continue;default:continue}}return n.isEmptyObject(t)?null:t},r.prototype.parseBodyComment=function(e,t){e.comment?e.comment+="\n"===t?t:"\n"+t:e.comment=t},r.prototype.parseBodyVariation=function(e){var t=[],i=null,r=0;if(i=this.stack[this.stack.length-1],r=e-i[0],r>0)this.stack.push([e,t]);else{do this.stack.pop(),i=this.stack[this.stack.length-1],r=e-i[0];while(0>=r);this.stack.push([e,t])}return t},r.prototype.parseBodySpecialMove=function(e){switch(e){case"先手の勝ち":case"後手の勝ち":case"上手の勝ち":case"下手の勝ち":return o.specialMove("投了");case"千日手":case"中断":case"持将棋":return o.specialMove(e);case"詰":return o.specialMove("詰み");case"先手の反則負け":case"後手の反則負け":case"上手の反則負け":case"下手の反則負け":return o.specialMove("反則負け")}return null},r.prototype.parseBodyFirstMove=function(e){for(var t=this.nextLine(n.toLines(e)),i=null,r=t(),o="";r;r=t()){switch(o=r.charAt(0)){case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":return i=this.parseMove(r);default:continue}break}return null},r.prototype.parseBodyFirstTurn=function(e){return null===e?!0:"undefined"==typeof e.turn?!0:e.turn},r.prototype.parseBody=function(e,t){var i=a.createMainObject(),r=a.createVariationsObject(),o="",s="",c=0,u=null,p=0,h=!0,f=null,l=null;this.stack.push([0,i]),l=i,u=this.parseBodyFirstMove(e),c=u.num,p=c%2,h=this.parseBodyFirstTurn(t);for(var d=this.nextLine(n.toLines(e)),y=d();y;y=d())switch(o=y.charAt(0),f=y.match(/^(.+?)：[\s　]*(\d+)[\s　]*手$/),null!==f&&(o=n.trim(f[1]),s=parseInt(f[2],10)),o){case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":var U=this.parseMove(y);if(c=this.checkMoves(c,U.num),this.storeMove(U),U.special){l.push({special:U.special});continue}l.push({move:{turn:this.takeTurn(p,h,U.num),to:U.to,from:U.from,piece:U.piece,time:U.time}});continue;case"*":var v="*"===y?"\n":y.slice(1);this.parseBodyComment(l[l.length-1],v);continue;case"変化":var F=[],P=null,k=0;if(s>c-1)throw new Error("moves of variation is invalid.");c=s,F=this.parseBodyVariation(s),r.push([s,F]),l=F,P=this.stack[this.stack.length-2],k=s-1-P[0],this.storeMove(P[1][k].move);continue;case"ま":var m="",K=y.match(/^まで\d{1,3}手で(.*)$/);null!==K&&"undefined"==typeof l[l.length-1].special&&(m=this.parseBodySpecialMove(K[1]),null!==m&&l.push({special:m}));continue;default:continue}if(1===i.length)throw new Error("This is invalid file.");return 0===r.length?{main:i}:{main:i,variations:r}},r.prototype.takeTurn=function(e,t,i){return e%2===i%2?t:!t},r.prototype.checkMoves=function(e,t){if(e!==t)throw new Error("moves is not in the order.");return e+1},r.prototype.storeMove=function(e){this.move=e},r.prototype.loadMove=function(){return this.move},r.prototype.parseMoveTo=function(e){var t=0,i=0;return"同"===e.charAt(0)?this.loadMove().to.concat():(t=o.zenkakNumber(e.charAt(0)),i=o.kansuji(e.charAt(1)),null!==t&&null!==i?[t,i]:null)},r.prototype.parseMoveFrom=function(e,t){var i=0,r=0;return"打"===e?[0,0]:"undefined"!=typeof t&&(i=parseInt(t.charAt(0),10),r=parseInt(t.charAt(1),10),i&&r)?[i,r]:null},r.prototype.parseMovePiece=function(e,t){return"成"===t?o.promotedPiece(e.slice(2)+"成"):o.piece(e.slice(2))},r.prototype.parseMoveTime=function(e){var t=e.match(/^(\d+):(\d+).*$/);return null!==t?60*parseInt(t[1],10)+parseInt(t[2],10):null},r.prototype.parseMoveLine=function(e){var t=new RegExp("^(\\d{1,3})\\s+((?:(?:同　|[１２３４５６７８９][一二三四五六七八九]成?)|[^同１２３４５６７８９])[^ (\\d)打成]+)(打|成)?(?:\\((\\d{2})\\))?(?:$|\\s*\\(\\s*([^ ]+)\\s*\\)$)");return e.match(t)},r.prototype.parseMove=function(e){var t=0,i=[],r=[],a=0,s=0,c=this.parseMoveLine(e);if(null===c)throw new Error("move is syntax error.");if(t=parseInt(c[1],10),null!==o.specialMove(c[2]))return{num:t,special:o.specialMove(c[2])};if(i=this.parseMoveTo(c[2]),a=this.parseMovePiece(c[2],c[3]),r=this.parseMoveFrom(c[3],c[4]),s="undefined"!=typeof s?this.parseMoveTime(n.trim(c[5])):0,null===i||null===r||null===a||null===s)throw new Error("move is syntax error.");return{num:t,to:i,from:r,piece:a,time:s}},r.prototype.nextLine=function(e){var t=-1;return function(){var i="";return t+=1,i=e[t],"undefined"==typeof i?null:("#"===i.charAt(0)&&(t+=1),e[t]?n.trim(e[t]):null)}},r.prototype.splitSource=function(e){return e.match(/^([\s\S]+?)\r?(?:\n|\r)手数----指手---------消費時間--\r?(?:\n|\r)([\s\S]+)$/)},r.prototype.parse=function(){var e=this.splitSource(this.source),t=null;return null===e?{header:null,body:this.parseBody(this.source,null)}:(t=this.parseHeader(e[1]),{header:t,body:this.parseBody(e[2],t)})},e.exports=r},function(e,t,i){"use strict";function r(e,t){this.source=e,this.format=t,this.stack=[]}var n=i(1),o=i(2),a=i(3),s=i(4),c=i(20);n.inherits(r,s),r.prototype.parseBodyTurn=function(e){return this.unityTurnMark(e.match(/(?:^|^[\s\S]+?(?:\r?(?:\n|\r)))([▲▼△▽])/)[1])},r.prototype.parseBody=function(e,t){var i=a.createMainObject(),r=a.createVariationsObject(),o="",s="",u=null,p="",h=null,f=null,l=null;this.stack.push([0,i]),h=i,p=this.parseBodyTurn(e),f=this.nextLine(this.bodyToLines(n.toLines(e))),l=new c(t,p);for(var d=f();d;d=f())switch(o=d.charAt(0),u=d.match(/^(.+?)：[\s　]*(\d+)[\s　]*手$/),null!==u&&(o=n.trim(u[1]),s=parseInt(u[2],10)),o){case"▲":case"▼":case"△":case"▽":var y=this.parseMove(d);p=this.turnCheck(p,y.turn),this.storeMove(y),y=l.complementMove(y),h.push({move:{turn:this.turnToBoolean(y.turn),to:y.to,from:y.from,piece:y.piece,time:0}});continue;case"*":var U="*"===d?"\n":d.slice(1);this.parseBodyComment(h[h.length-1],U);continue;case"変化":var v=[],F=null,P=0;if(l.checkVariationNumber(s)===!1)throw new Error("moves of variation is invalid.");v=this.parseBodyVariation(s),r.push([s,v]),h=v,F=this.stack[this.stack.length-2],P=s-1-F[0],this.storeMove(F[1][P].move),l.recessionBoard(s),p=l.getLastMoveTurn();continue;case"ま":var k="",m=d.match(/^まで\d{1,3}手で(.*)$/);null!==m&&"undefined"==typeof h[h.length-1].special&&(k=this.parseBodySpecialMove(m[1]),null!==k&&h.push({special:k}));continue;default:continue}if(1===i.length)throw new Error("This is invalid file.");return 0===r.length?{main:i}:{main:i,variations:r}},r.prototype.turnToBoolean=function(e){return"black"===e?!0:!1},r.prototype.turnCheck=function(e,t){if(e!==t)throw new Error("turn symbol is invalid.");return"black"===e?"white":"black"},r.prototype.unityTurnMark=function(e){return/^[▲▼]$/.test(e)?"black":"white"},r.prototype.parseMoveMotion=function(e){return"行"===e||"入"===e?"上":"下"===e?"引":e},r.prototype.parseMovePiece=function(e){return o.piece(/^同(?!　)/.test(e)?e.slice(1):e.slice(2))},r.prototype.parseMoveLine=function(e){var t=new RegExp("^([▲▼△▽])((?:同|同　|[１２３４５６７８９][一二三四五六七八九])成?[^右左直上行入引下寄成不打\\s　]+)([右左直])?([上行入引下寄])?([成打]|不成)?$");return e.match(t)},r.prototype.parseMove=function(e){var t="",i=[],r=0,n="",o=this.parseMoveLine(e);if(null===o)throw new Error("move is syntax error.");if(t=this.unityTurnMark(o[1]),i=this.parseMoveTo(o[2]),r=this.parseMovePiece(o[2]),n=this.parseMoveMotion(o[4]),null===i||null===r)throw new Error("move is syntax error.");return{turn:t,to:i,piece:r,relative:o[3],motion:n,modifier:o[5]}},r.prototype.bodyToLines=function(e){for(var t=[],i="",r=function(e){return"/"+e},o=0,a=e.length;a>o;o++)if(i=n.trim(e[o]),/[▲▼△▽]/.test(i.charAt(0))!==!1){i=i.replace(/[▲▼△▽]/g,r),i=i.split("/");for(var s=0,c=i.length;c>s;s++)""!==i[s]&&t.push(i[s])}else t.push(i);return t},r.prototype.splitSource=function(e){return/^\r?(?:\n|\r)*[\s　]*[*▲▼△▽]/.test(e)?[void 0,void 0,e]:e.match(/^([\s\S]+?)\r?(?:\n|\r)[\s　]*([*▲▼△▽][\s\S]+?)$/)},r.prototype.parse=function(){var e=this.splitSource(this.source),t=null;if(null===e)throw new Error("This file is invalid.");return"undefined"==typeof e[1]?{header:t,body:this.parseBody(this.source,t)}:(t=this.parseHeader(e[1]),{header:t,body:this.parseBody(e[2],t)})},e.exports=r},function(e,t,i){"use strict";function r(e,t){this.source=e,this.format=t}var n=i(1),o=i(2),a=i(3);r.prototype.parseHeaderBoard=function(e){for(var t=[],i="",r="",n=0,a=0;9>n;n++)if(a=2,e[n].slice(0,a)==="P"+(n+1))for(var s=0;9>s;s++,a+=3){if(r=e[n].slice(a,a+3),i=r.charAt(0),"-"===i||"+"===i){if(r=o.csaPiece(r.slice(1)),null===r)return null;r="-"===i?0-r:r}else{if(" * "!==r&&" *"!==r)return null;r=0}t.push(r)}return t},r.prototype.parseHeaderHand=function(e){for(var t={},i=0,r="",n=0,a=2,s=(e.length-2)/4;s>n;n++,a+=4){if(i=o.csaPiece(e.slice(a+2,a+4)),r=o.pieceToCsaPieceMapKey(i),null===i)return null;t[r]="undefined"==typeof t[r]?1:t[r]+1}return t},r.prototype.parseHeader=function(e){for(var t=a.createHeaderObject(),i="",r="",s=null,c=this.nextLine(n.toLines(e)),u=c();u;u=c())if(s=u.match(/^((?:\+|\-)$|P|V|N(?:\+|\-)|\$)(.*)$/),null!==s)switch(i=s[1],r=n.trim(s[2]),i){case"+":case"-":t.turn="+"===i?!0:!1;continue;case"N+":case"N-":t.players||(t.players={}),t.players["N+"===i?"black":"white"]=r;continue;case"$":if(s=u.match(/^(.+?):(.*)$/),null===s)continue;switch(i=o.csaHeader(s[1]),r=n.trim(s[2]),i){case"start":case"end":if(!n.validateDate(r))continue;t.date||(t.date={}),t.date[i]=r;break;case"event":case"opening":case"site":t[i]=r;break;case"limit":t.time||(t.time={}),t.time[i]=r}continue;case"P":switch(r.charAt(0)){case"I":break;case"1":for(var p=u,h=[u],f=2;9>=f;){if(u=c(),null===u||"P"!==u.charAt(0))throw new Error("position figure is invalid.");if(parseInt(u.charAt(1),10)!==f)throw new Error("position figure is invalid.");p+=u,h.push(u),f+=1}if(t.handicap=o.csaHandicap(p),t.handicap===o.csaHandicap("その他")){if(t.handicap=o.csaHandicap("平手"),p=this.parseHeaderBoard(h),null===p)throw new Error("position figure is invalid.");t.board=p}break;case"-":case"+":var l=this.parseHeaderHand(u);if(null===l)throw new Error("hand piece is Invlid.");"undefined"==typeof t.hands&&(t.hands={}),t.hands["+"===r.charAt(0)?"black":"white"]=l}continue;case"V":continue;default:continue}return n.isEmptyObject(t)?null:t},r.prototype.parseBodyComment=function(e,t){e.comment?e.comment+="\n"===t?t:"\n"+t:e.comment=t},r.prototype.parseBody=function(e){var t=a.createMainObject(),i="",r="",s=null;s=this.nextLine(this.eachSepComma(n.toLines(e))),r=s();for(var c=s();c;c=s())switch(i=c.charAt(0)){case"+":case"-":var u=this.parseMove(c);r=this.turnCheck(r,u.turn),t.push({move:{turn:this.turnToBoolean(u.turn),to:u.to,from:u.from,piece:u.piece,time:0}});continue;case"'":if("*"!==c.charAt(1))continue;var p="/'*"===c?"\n":c.slice(2);this.parseBodyComment(t[t.length-1],p);continue;case"T":var h=parseInt(c.slice(1),10);isNaN(h)===!1&&t[t.length-1].move&&(t[t.length-1].move.time=h);continue;case"%":null!==o.csaSpecialMove(c)&&t.push({special:c});continue;default:continue}if(1===t.length)throw new Error("This file is invalid.");return{main:t}},r.prototype.turnToBoolean=function(e){return"+"===e?!0:!1},r.prototype.turnCheck=function(e,t){if(e!==t)throw new Error("turn symbol is invalid.");return"+"===e?"-":"+"},r.prototype.parseMovePiece=function(e){return o.csaPiece(e)},r.prototype.parseMoveLine=function(e){return e.match(/^([+-])(\d{2})(\d{2})([A-Z]{2})$/)},r.prototype.parseMove=function(e){var t="",i=[],r=[],n="",o=this.parseMoveLine(e);if(null===o)throw new Error("move is syntax error.");if(t=o[1],r=[parseInt(o[2].charAt(0),10),parseInt(o[2].charAt(1),10)],i=[parseInt(o[3].charAt(0),10),parseInt(o[3].charAt(1),10)],n=this.parseMovePiece(o[4]),null===n)throw new Error("move is syntax error.");return{turn:t,to:i,from:r,piece:n}},r.prototype.eachSepComma=function(e){for(var t=[],i="",r=0,o=e.length;o>r;r++)switch(i=n.trim(e[r]),i.charAt(0)){case"+":case"-":case"T":case"%":for(var a=i.split(/,/),s=0,c=a.length;c>s;s++)""!==a[s]&&t.push(a[s]);continue;default:t.push(e[r]);continue}return t},r.prototype.nextLine=function(e){var t=-1;return function(){var i="";return t+=1,i=e[t],"undefined"==typeof i?null:("'"===i.charAt(0)&&"*"!==i.charAt(1)&&(t+=1),e[t]?n.trim(e[t]):null)}},r.prototype.separatorSource=function(e){return e.split(/(?:\n|\r)\/\r?(?:\n|\r)/,1)[0]},r.prototype.splitSource=function(e){var t=new RegExp("(^(?:[\\s\\S]+?\\r?(?:\\n|\\r))?(?:\\+|\\-))\\r?(?:\\n|\\r)"),i=new RegExp("^(?:[\\s\\S]+?\\r?(?:\\n|\\r))?((?:\\+|\\-)\\r?(?:\\n|\\r)[\\s\\S]+)$"),r=e.match(t),n=e.match(i);return null!==r&&null!==n?[r[1],n[1]]:null},r.prototype.parse=function(){var e=this.separatorSource(this.source);if(e=this.splitSource(e),null===e)throw new Error("This file is invalid.");return{header:this.parseHeader(e[0]),body:this.parseBody(e[1])}},e.exports=r},function(e){"use strict";var t={};t["P1-KY-KE-GI-KI-OU-KI-GI-KE-KYP2 * -HI *  *  *  *  * -KA *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=0,t["P1-KY-KE-GI-KI-OU-KI-GI-KE *P2 * -HI *  *  *  *  * -KA *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=1,t["P1 * -KE-GI-KI-OU-KI-GI-KE-KYP2 * -HI *  *  *  *  * -KA *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=2,t["P1-KY-KE-GI-KI-OU-KI-GI-KE-KYP2 * -HI *  *  *  *  *  *  *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=3,t["P1-KY-KE-GI-KI-OU-KI-GI-KE-KYP2 *  *  *  *  *  *  * -KA *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=4,t["P1-KY-KE-GI-KI-OU-KI-GI-KE *P2 *  *  *  *  *  *  * -KA *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=5,t["P1-KY-KE-GI-KI-OU-KI-GI-KE-KYP2 *  *  *  *  *  *  *  *  *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=6,t["P1 * -KE-GI-KI-OU-KI-GI-KE *P2 *  *  *  *  *  *  *  *  *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=7,t["P1 *  * -GI-KI-OU-KI-GI-KE *P2 *  *  *  *  *  *  *  *  *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=8,t["P1 * -KE-GI-KI-OU-KI-GI *  *P2 *  *  *  *  *  *  *  *  *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=9,t["P1 *  * -GI-KI-OU-KI-GI *  *P2 *  *  *  *  *  *  *  *  *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=10,t["P1 *  *  * -KI-OU-KI *  *  *P2 *  *  *  *  *  *  *  *  *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=11,t["P1 *  *  *  * -OU *  *  *  *P2 *  *  *  *  *  *  *  *  *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=12,t["P1 *  *  *  * -OU *  *  *  *P2 *  *  *  *  *  *  *  *  *P3 *  *  *  *  *  *  *  *  *P4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=13,t["その他"]=14,e.exports=t},function(e){"use strict";var t={$START_TIME:"start",$END_TIME:"end",$EVENT:"event",$OPENING:"opening",$TIME_LIMIT:"limit",$SITE:"site"};e.exports=t},function(e){"use strict";var t={FU:1,KY:2,KE:3,GI:4,KI:5,KA:6,HI:7,OU:8,TO:9,NY:10,NK:11,NG:12,UM:13,RY:14};e.exports=t},function(e){"use strict";var t={"%TORYO":"%TORYO","%TSUMI":"%TSUMI","%SENNICHITE":"%SENNICHITE","%CHUDAN":"%CHUDAN","%JISHOGI":"%JISHOGI","%ILLEGAL_MOVE":"%ILLEGAL_MOVE"};e.exports=t},function(e){"use strict";var t={kif:"Kif",Kif:"Kif",KIF:"Kif",ki2:"Ki2",Ki2:"Ki2",KI2:"Ki2",csa:"Csa",Csa:"Csa",CSA:"Csa",noformat:"noformat"};e.exports=t},function(e){"use strict";var t={"平手":0,"香落ち":1,"右香落ち":2,"角落ち":3,"飛車落ち":4,"飛香落ち":5,"二枚落ち":6,"四枚落ち":7,"五枚落ち":8,"左五枚落ち":9,"六枚落ち":10,"八枚落ち":11,"十枚落ち":12,"玉一枚":13,"その他":14};e.exports=t},function(e){"use strict";var t={"開始日時":"start","終了日時":"end","表題":"title","棋戦":"event","戦型":"opening","先手戦術":"tactics_black","後手戦術":"tactics_white","持ち時間":"limit","消費時間":"used","場所":"site","手合割":"handicap","先手":"player_black","下手":"player_black","後手":"player_white","上手":"player_white","９":"board","先手の持駒":"hand_black","下手の持駒":"hand_black","上手の持駒":"hand_white","後手の持駒":"hand_white","後手番":"turn"};e.exports=t},function(e){"use strict";var t=[[-2,-3,-4,-5,-8,-5,-4,-3,-2,0,-7,0,0,0,0,0,-6,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[-2,-3,-4,-5,-8,-5,-4,-3,0,0,-7,0,0,0,0,0,-6,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[0,-3,-4,-5,-8,-5,-4,-3,-2,0,-7,0,0,0,0,0,-6,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[-2,-3,-4,-5,-8,-5,-4,-3,-2,0,-7,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[-2,-3,-4,-5,-8,-5,-4,-3,-2,0,0,0,0,0,0,0,-6,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[-2,-3,-4,-5,-8,-5,-4,-3,0,0,0,0,0,0,0,0,-6,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[-2,-3,-4,-5,-8,-5,-4,-3,-2,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[0,-3,-4,-5,-8,-5,-4,-3,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[0,0,-4,-5,-8,-5,-4,-3,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[0,-3,-4,-5,-8,-5,-4,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[0,0,-4,-5,-8,-5,-4,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[0,0,0,-5,-8,-5,0,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[0,0,0,0,-8,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[0,0,0,0,-8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2]];e.exports=t},function(e){"use strict";var t={"一":1,"二":2,"三":3,"四":4,"五":5,"六":6,"七":7,"八":8,"九":9,"十":10};e.exports=t},function(e){"use strict";var t={"歩":1,"香":2,"桂":3,"銀":4,"金":5,"角":6,"飛":7,"王":8,"玉":8,"と":9,"成香":10,"杏":10,"成桂":11,"圭":11,"成銀":12,"全":12,"馬":13,"龍":14};e.exports=t},function(e){"use strict";var t={"歩成":9,"香成":10,"桂成":11,"銀成":12,"角成":13,"飛成":14};e.exports=t},function(e){"use strict";var t={"投了":"%TORYO","詰み":"%TSUMI","千日手":"%SENNICHITE","中断":"%CHUDAN","持将棋":"%JISHOGI","反則負け":"%ILLEGAL_MOVE"};e.exports=t},function(e){"use strict";var t={"１":1,"２":2,"３":3,"４":4,"５":5,"６":6,"７":7,"８":8,"９":9};e.exports=t},function(e,t,i){"use strict";function r(e,t){this.initialize.call(this,e,t)}var n=i(2),o=i(21);r.prototype.initialize=function(e,t){var i=0,r=[];if(null===e)return void(this.board=new o(this.getInitPlacement(n.handicap("平手")),t));if(i="undefined"==typeof e.handicap?n.handicap("平手"):e.handicap,i===n.handicap("その他")&&"undefined"==typeof e.board)throw new Error("Check the board and handicap in kifu.");r="undefined"!=typeof e.board?e.board:this.getInitPlacement(i),this.board=new o(r,t,e.hands)},r.prototype.complementMove=function(e){var t=this.advanceBoard(e);return e.from=t.from,"成"===e.modifier&&(e.piece=t.piece.getPiece()),e},r.prototype.advanceBoard=function(e){var t=[],i=null,r=null;if(i=this.board.findPiece(e),null===i)throw new Error("Have specified a piece that can not be used.");return this.board.setTurn(e.turn),this.board.saveMoveRecord(i,e),r=this.board.capturePiece(e.to[0],e.to[1]),t=[i.getFile(),i.getRank()],this.board.movePiece(i,e.to[0],e.to[1]),"成"===e.modifier&&this.board.promotePiece(i),{from:t,piece:i}},r.prototype.recessionBoard=function(e){this.board.restoreMoveRecord(e)},r.prototype.getLastMoveTurn=function(){return this.board.getTurn()},r.prototype.checkVariationNumber=function(e){var t=this.board.getRecord();return e<=t.length?!0:!1},r.prototype.getInitPlacement=function(e){var t=n.initialPlacement(e);return null===t?n.initialPlacement(n.handicap("平手")):t},e.exports=r},function(e,t,i){"use strict";function r(e,t,i){this.initialize.call(this,e,t,i)}var n=i(2),o=i(22),a=i(23);r.prototype.initialize=function(e,t,i){this.boardPieces=new o(n.piece("龍")),this.handPieces=new o(n.piece("飛")),this.turn=t,this.board=this.initializeBoard(e),"undefined"!=typeof i&&this.initializeHand(i),this.record=[]},r.prototype.initializeHand=function(e){for(var t in e)for(var i in e[t])for(var r=0,o=e[t][i];o>r;r++)this.handPieces.add(new a(n.csaPiece(i),t,0,0))},r.prototype.initializeBoard=function(e){for(var t=null,i=0,r=[],n=1;9>=n;n++)r[n]=[];for(n=1;9>=n;n++)for(var o=9;o>=1;o--)t=0<e[i]?new a(e[i],"black",o,n):0>e[i]?new a(-1*e[i],"white",o,n):null,null!==t&&this.boardPieces.add(t),r[o][n]=t,i+=1;return r},r.prototype.setTurn=function(e){this.turn=e},r.prototype.getTurn=function(){return this.turn},r.prototype.getRecord=function(){return this.record},r.prototype.findPiece=function(e){var t=0,i=0,r=null,n=[];if("打"!==e.modifier)for(n=this.boardPieces.getPieces(e.piece),t=0,i=this.boardPieces.getPiecesCount(e.piece);i>t;t++)if(r=n[t],r.getPlayer()===e.turn&&r.matchMovement(e)&&!this.checkPowerOfMove(r,e))return r;for(n=this.handPieces.getPieces(e.piece),t=0,i=this.handPieces.getPiecesCount(e.piece);i>t;t++)if(r=n[t],r.getPlayer()===e.turn&&!this.checkPowerOfMove(r,e))return this.handPieces.remove(r,t),this.boardPieces.add(r),r;return null},r.prototype.capturePiece=function(e,t){var i=this.board[e][t];return null===i?null:(this.boardPieces.remove(i),i.captured(),this.handPieces.add(i),i)},r.prototype.promotePiece=function(e){this.boardPieces.remove(e),
e.promote(),this.boardPieces.add(e)},r.prototype.movePiece=function(e,t,i){0!==e.getFile()&&0!==e.getRank()&&(this.board[e.getFile()][e.getRank()]=null),this.board[t][i]=e,e.update({file:t,rank:i})},r.prototype.checkPowerOfMove=function(e,t){var i=e.getFile()-t.to[0],r=e.getRank()-t.to[1],o=this.board[t.to[0]][t.to[1]];if(null!==o&&o.getPlayer()===t.turn)return!0;if(e.getPiece()===n.piece("桂"))return!1;if(0===e.getFile()&&0===e.getRank())return null!==o?!0:!1;i>0?i=-1:0>i&&(i=1),r>0?r=-1:0>r&&(r=1);for(var a=1;e.getFile()+a*i!==t.to[0]||e.getRank()+a*r!==t.to[1];a++)if(null!==this.board[e.getFile()+a*i][e.getRank()+a*r])return!0;return!1},r.prototype.saveMoveRecord=function(e,t){var i={},r=this.board[t.to[0]][t.to[1]];i.turn=t.turn,i.movedPieceData={pieceObject:e,originPiece:e.getPiece(),originPosition:[e.getFile(),e.getRank()],modifier:t.modifier},null!==r&&(i.capturedPieceData={pieceObject:r,originPiece:r.getPiece(),originPosition:[r.getFile(),r.getRank()],player:r.getPlayer()}),this.record.push(i)},r.prototype.restoreDropPiece=function(e){this.board[e.pieceObject.getFile()][e.pieceObject.getRank()]=null,this.boardPieces.remove(e.pieceObject),this.handPieces.add(e.pieceObject),e.pieceObject.update({file:0,rank:0})},r.prototype.restoreMovedPiece=function(e){this.board[e.pieceObject.getFile()][e.pieceObject.getRank()]=null,this.board[e.originPosition[0]][e.originPosition[1]]=e.pieceObject,"成"===e.modifier&&this.boardPieces.remove(e.pieceObject),e.pieceObject.update({piece:e.originPiece,file:e.originPosition[0],rank:e.originPosition[1]}),"成"===e.modifier&&this.boardPieces.add(e.pieceObject)},r.prototype.restoreCapturedPiece=function(e){this.board[e.originPosition[0]][e.originPosition[1]]=e.pieceObject,this.handPieces.remove(e.pieceObject),e.pieceObject.update({piece:e.originPiece,player:e.player,file:e.originPosition[0],rank:e.originPosition[1]}),this.boardPieces.add(e.pieceObject)},r.prototype.restoreMoveRecord=function(e){var t=null;e-=1;for(var i=this.record.length-1;i>=e;i--)t=this.record.pop(),this.turn=t.turn,0!==t.movedPieceData.originPosition[0]||0!==t.movedPieceData.originPosition[1]?(this.restoreMovedPiece(t.movedPieceData),"undefined"!=typeof t.capturedPieceData&&this.restoreCapturedPiece(t.capturedPieceData)):this.restoreDropPiece(t.movedPieceData)},e.exports=r},function(e){"use strict";function t(e){this.initialize.call(this,e)}t.prototype.initialize=function(e){this.list=[];for(var t=0;e>=t;t++)this.list[t]=[]},t.prototype.add=function(e){this.list[e.getPiece()].push(e)},t.prototype.remove=function(e,t){if("undefined"==typeof t&&(t=this.getPieceIndex(e),-1===t))throw new Error("[PieceList.prototype.remove] Internal error.");this.list[e.getPiece()].splice(t,1)},t.prototype.getPieces=function(e){return this.list[e]},t.prototype.getPiecesCount=function(e){return this.list[e].length},t.prototype.getPieceIndex=function(e){for(var t=this.getPieces(e.getPiece()),i=0,r=this.getPiecesCount(e.getPiece());r>i;i++)if(e===t[i])return i;return-1},e.exports=t},function(e,t,i){"use strict";function r(e,t,i,r){this.piece=e,this.player=t,this.file=i,this.rank=r}var n=i(2);r.prototype.getPiece=function(){return this.piece},r.prototype.getFile=function(){return this.file},r.prototype.getRank=function(){return this.rank},r.prototype.getPlayer=function(){return this.player},r.prototype.update=function(e){"undefined"!=typeof e.piece&&(this.piece=e.piece),"undefined"!=typeof e.player&&(this.player=e.player),"undefined"!=typeof e.file&&(this.file=e.file),"undefined"!=typeof e.rank&&(this.rank=e.rank)},r.prototype.promote=function(){this.piece=n.promotedPiece(n.pieceToPieceMapKey(this.piece)+"成")},r.prototype.demote=function(){switch(this.piece){case n.piece("と"):this.piece=n.piece("歩");break;case n.piece("成香"):this.piece=n.piece("香");break;case n.piece("成桂"):this.piece=n.piece("桂");break;case n.piece("成銀"):this.piece=n.piece("銀");break;case n.piece("馬"):this.piece=n.piece("角");break;case n.piece("龍"):this.piece=n.piece("飛")}},r.prototype.captured=function(){this.player="black"===this.player?"white":"black",this.file=0,this.rank=0,this.demote()},r.prototype.matchMovement=function(e){return this["case"+n.pieceToCsaPieceMapKey(e.piece)](e)},r.prototype.checkRelative=function(e,t){var i=0;switch((e.piece===n.piece("馬")||e.piece===n.piece("龍"))&&(i="右"===e.relative&&"white"===this.player||"左"===e.relative&&"black"===this.player?-1:1),e.relative){case"右":if("black"===this.player){if(t>=i)return!1}else if(i>=t)return!1;break;case"左":if("black"===this.player){if(i>=t)return!1}else if(t>=i)return!1;break;case"直":if(0!==t)return!1}return!0},r.prototype.checkMotion=function(e,t){switch(e.motion){case"上":if("black"===this.player){if(0>=t)return!1}else if(t>=0)return!1;break;case"引":if("black"===this.player){if(t>=0)return!1}else if(0>=t)return!1;break;case"寄":if(0!==t)return!1}return!0},r.prototype.checkDestForward=function(e,t){var i="black"===this.player?-1:1;return this.file===e&&this.rank+i===t?!0:!1},r.prototype.checkDestBackward=function(e,t){var i="black"===this.player?1:-1;return this.file===e&&this.rank+i===t?!0:!1},r.prototype.checkDestUpperLeft=function(e,t){var i="black"===this.player?1:-1,r="black"===this.player?-1:1;return this.file+i===e&&this.rank+r===t?!0:!1},r.prototype.checkDestLeft=function(e,t){var i="black"===this.player?1:-1;return this.file+i===e&&this.rank===t?!0:!1},r.prototype.checkDestBottomLeft=function(e,t){var i="black"===this.player?1:-1,r="black"===this.player?1:-1;return this.file+i===e&&this.rank+r===t?!0:!1},r.prototype.checkDestUpperRight=function(e,t){var i="black"===this.player?-1:1,r="black"===this.player?-1:1;return this.file+i===e&&this.rank+r===t?!0:!1},r.prototype.checkDestRight=function(e,t){var i="black"===this.player?-1:1;return this.file+i===e&&this.rank===t?!0:!1},r.prototype.checkDestBottomRight=function(e,t){var i="black"===this.player?-1:1,r="black"===this.player?1:-1;return this.file+i===e&&this.rank+r===t?!0:!1},r.prototype.checkDestDirectly=function(e,t){for(var i="black"===this.player?this.rank:10-this.rank,r=1;--i;r++)if(this.file===e&&this.rank+("black"===this.player?-r:r)===t)return!0;return!1},r.prototype.checkDestDiagonal=function(e,t){var i=0,r=0;for(i=this.file+1,r=this.rank-1;9>=i&&r>=1;i++,r--)if(i===e&&r===t)return!0;for(i=this.file+1,r=this.rank+1;9>=i&&9>=r;i++,r++)if(i===e&&r===t)return!0;for(i=this.file-1,r=this.rank-1;i>=1&&r>=1;i--,r--)if(i===e&&r===t)return!0;for(i=this.file-1,r=this.rank+1;i>=1&&9>=r;i--,r++)if(i===e&&r===t)return!0;return!1},r.prototype.checkDestOrthogonal=function(e,t){var i=0,r=0;for(i=this.file+1;9>=i;i++)if(i===e&&this.rank===t)return!0;for(r=this.rank-1;r>=1;r--)if(this.file===e&&r===t)return!0;for(i=this.file-1;i>=1;i--)if(i===e&&this.rank===t)return!0;for(r=this.rank+1;9>=r;r++)if(this.file===e&&r===t)return!0;return!1},r.prototype.caseFU=function(e){return this.checkDestForward(e.to[0],e.to[1])?!0:!1},r.prototype.caseKY=function(e){return this.checkDestDirectly(e.to[0],e.to[1])?!0:!1},r.prototype.caseKE=function(e){var t=this.file-e.to[0];return this.checkRelative(e,t)?1!==t&&-1!==t?!1:this.rank+("black"===this.player?-2:2)===e.to[1]?!0:!1:!1},r.prototype.caseGI=function(e){var t=this.file-e.to[0],i=this.rank-e.to[1];return this.checkRelative(e,t)&&this.checkMotion(e,i)?this.checkDestUpperLeft(e.to[0],e.to[1])?!0:this.checkDestBottomLeft(e.to[0],e.to[1])?!0:this.checkDestUpperRight(e.to[0],e.to[1])?!0:this.checkDestBottomRight(e.to[0],e.to[1])?!0:this.checkDestForward(e.to[0],e.to[1])?!0:!1:!1},r.prototype.caseKI=function(e){var t=this.file-e.to[0],i=this.rank-e.to[1];return this.checkRelative(e,t)&&this.checkMotion(e,i)?this.checkDestUpperLeft(e.to[0],e.to[1])?!0:this.checkDestLeft(e.to[0],e.to[1])?!0:this.checkDestUpperRight(e.to[0],e.to[1])?!0:this.checkDestRight(e.to[0],e.to[1])?!0:this.checkDestForward(e.to[0],e.to[1])?!0:this.checkDestBackward(e.to[0],e.to[1])?!0:!1:!1},r.prototype.caseKA=function(e){var t=this.file-e.to[0],i=this.rank-e.to[1];return this.checkRelative(e,t)&&this.checkMotion(e,i)&&this.checkDestDiagonal(e.to[0],e.to[1])?!0:!1},r.prototype.caseHI=function(e){var t=this.file-e.to[0],i=this.rank-e.to[1];return this.checkRelative(e,t)&&this.checkMotion(e,i)&&this.checkDestOrthogonal(e.to[0],e.to[1])?!0:!1},r.prototype.caseOU=function(e){return this.checkDestUpperLeft(e.to[0],e.to[1])?!0:this.checkDestLeft(e.to[0],e.to[1])?!0:this.checkDestBottomLeft(e.to[0],e.to[1])?!0:this.checkDestUpperRight(e.to[0],e.to[1])?!0:this.checkDestRight(e.to[0],e.to[1])?!0:this.checkDestBottomRight(e.to[0],e.to[1])?!0:this.checkDestForward(e.to[0],e.to[1])?!0:this.checkDestBackward(e.to[0],e.to[1])?!0:!1},r.prototype.caseTO=function(e){return this.caseKI(e)},r.prototype.caseNY=function(e){return this.caseKI(e)},r.prototype.caseNK=function(e){return this.caseKI(e)},r.prototype.caseNG=function(e){return this.caseKI(e)},r.prototype.caseUM=function(e){var t=this.file-e.to[0],i=this.rank-e.to[1];return this.checkRelative(e,t)&&this.checkMotion(e,i)?this.checkDestUpperLeft(e.to[0],e.to[1])?!0:this.checkDestLeft(e.to[0],e.to[1])?!0:this.checkDestBottomLeft(e.to[0],e.to[1])?!0:this.checkDestUpperRight(e.to[0],e.to[1])?!0:this.checkDestRight(e.to[0],e.to[1])?!0:this.checkDestBottomRight(e.to[0],e.to[1])?!0:this.checkDestForward(e.to[0],e.to[1])?!0:this.checkDestBackward(e.to[0],e.to[1])?!0:this.checkDestDiagonal(e.to[0],e.to[1])?!0:!1:!1},r.prototype.caseRY=function(e){var t=this.file-e.to[0],i=this.rank-e.to[1];return this.checkRelative(e,t)&&this.checkMotion(e,i)?this.checkDestUpperLeft(e.to[0],e.to[1])?!0:this.checkDestLeft(e.to[0],e.to[1])?!0:this.checkDestBottomLeft(e.to[0],e.to[1])?!0:this.checkDestUpperRight(e.to[0],e.to[1])?!0:this.checkDestRight(e.to[0],e.to[1])?!0:this.checkDestBottomRight(e.to[0],e.to[1])?!0:this.checkDestForward(e.to[0],e.to[1])?!0:this.checkDestBackward(e.to[0],e.to[1])?!0:this.checkDestOrthogonal(e.to[0],e.to[1])?!0:!1:!1},e.exports=r}]);